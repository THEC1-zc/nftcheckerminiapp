<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chickenfish Levels</title>
    
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        const run = async () => { await sdk.actions.ready(); };
        run();
    </script>

    <style>
        :root { --primary: #FFC107; --accent: #FF9800; --bg: #fffbf0; --card-bg: #ffffff; --text: #3e2723; --green: #2ecc71; --blue: #3498db; --red: #e74c3c; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg);
            color: var(--text); 
            padding: 15px; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-x: hidden; 
        }
        
        .nav-header { width: 100%; max-width: 600px; display: flex; margin-bottom: 20px; justify-content: space-between; align-items: center;}
        .back-btn { text-decoration: none; color: #5d4037; font-weight: 600; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; }
        
        .container { width: 100%; max-width: 600px; box-sizing: border-box; }

        h2 { text-align: center; margin-top: 0; font-weight: 900; color: var(--text); margin-bottom: 5px; font-size: 1.8rem; }
        .subtitle { text-align: center; color: #795548; font-size: 0.9rem; margin-bottom: 25px; }

        .loading-container { text-align: center; margin: 40px 0; }
        .loading-spinner { 
            border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: #888; font-size: 0.8rem; font-weight: 600; }
        .progress-bar { width: 200px; height: 6px; background: #eee; border-radius: 3px; margin: 10px auto; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }

        /* GRID SYSTEM */
        .nft-list { display: flex; flex-direction: column; gap: 20px; width: 100%; }
        
        .nft-card { 
            background: #fff; border: 1px solid #efebe9; border-radius: 20px; overflow: hidden; 
            box-shadow: 0 8px 20px rgba(62, 39, 35, 0.08); transition: transform 0.2s;
            display: flex; flex-direction: row; align-items: center;
            height: 140px; position: relative;
        }
        
        /* Level Badge */
        .level-badge {
            position: absolute; top: 10px; left: 10px; z-index: 2;
            background: rgba(0,0,0,0.7); color: white; padding: 4px 10px;
            border-radius: 8px; font-size: 0.7rem; font-weight: 800; backdrop-filter: blur(4px);
        }

        .nft-img { width: 140px; height: 140px; object-fit: cover; flex-shrink: 0; background: #fff8e1; }
        
        .nft-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; height: 100%; box-sizing: border-box; }
        
        .nft-header { display: flex; justify-content: space-between; align-items: start; }
        .nft-name { font-weight: 900; font-size: 1rem; color: var(--text); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .token-id { font-size: 0.7rem; color: #a1887f; font-family: monospace; }
        
        .price-label { font-size: 0.65rem; text-transform: uppercase; color: #aaa; font-weight: 700; margin-top: 5px; }
        .price-row { display: flex; align-items: baseline; gap: 8px; }
        .price-eth { font-size: 1.2rem; font-weight: 900; color: var(--accent); }
        .price-usd { font-size: 0.85rem; color: #8d6e63; font-weight: 500; }
        
        .action-btn {
            text-decoration: none; background: #3e2723; color: white; 
            padding: 8px 15px; border-radius: 10px; font-weight: 700; font-size: 0.8rem;
            text-align: center; margin-top: auto; display: inline-block; width: fit-content;
        }
        
        .not-found-msg { text-align: center; padding: 20px; color: #aaa; font-style: italic; display: none; }
        .error-msg { color: var(--red); text-align: center; font-weight: 600; padding: 20px; display: none; }

        .version-tag { text-align: center; font-size: 0.7rem; color: #8d6e63; margin-top: 25px; font-weight: 800; font-family: monospace; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="nav-header">
        <a href="index.html" class="back-btn">⬅ Home</a>
    </div>

    <div class="container">
        <h2>Chickenfish Levels</h2>
        <div class="subtitle">Searching specifically for Levels 1-5</div>

        <div id="loader" class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Connecting to Alchemy...</div>
            <div class="progress-bar"><div id="progress" class="progress-fill"></div></div>
        </div>
        
        <div id="error" class="error-msg"></div>

        <div id="list" class="nft-list"></div>
        
        <div class="version-tag">v2.5 (Pure Alchemy Logic)</div>
    </div>

    <script>
        const COLLECTION_ADDR = "0x84eea2be67b17698b0e09b57eeeda47aa921bbf0".toLowerCase();
        const ALCHEMY_KEY = '46kIRKE_HvuVkuRbPNRbh'; 

        window.addEventListener('DOMContentLoaded', startEngine);

        async function startEngine() {
            const loader = document.getElementById('loader');
            const progress = document.getElementById('progress');
            const loadingText = document.querySelector('.loading-text');
            const errorDiv = document.getElementById('error');
            const listDiv = document.getElementById('list');

            try {
                // 1. Get Global Floor Price & ETH Price (For Value Display)
                loadingText.innerText = "Fetching Floor Price...";
                progress.style.width = "10%";

                const [floorData, ethData] = await Promise.all([
                    fetch(`https://base-mainnet.g.alchemy.com/nft/v3/${ALCHEMY_KEY}/getFloorPrice?contractAddress=${COLLECTION_ADDR}`).then(r => r.json()),
                    fetch("https://api.coinbase.com/v2/prices/ETH-USD/spot").then(r => r.json())
                ]);

                const floorEth = floorData.openSea?.floorPrice || 0;
                const ethPrice = parseFloat(ethData.data.amount);
                
                // 2. Scan for Levels 1-5
                // We need to find one example for each level.
                const levelsFound = { 1: null, 2: null, 3: null, 4: null, 5: null };
                let levelsCount = 0;
                let pageKey = "";
                let attempts = 0;
                const MAX_ATTEMPTS = 5; // Scan up to 500 items max

                loadingText.innerText = "Scanning Collection Traits...";

                while (levelsCount < 5 && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    progress.style.width = `${10 + (attempts * 15)}%`;
                    
                    // Fetch Batch of 100
                    let url = `https://base-mainnet.g.alchemy.com/nft/v3/${ALCHEMY_KEY}/getNFTsForContract?contractAddress=${COLLECTION_ADDR}&withMetadata=true&limit=100`;
                    if (pageKey) url += `&pageKey=${pageKey}`;

                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if (!data.nfts) break;

                    // Analyze Batch
                    for (const nft of data.nfts) {
                        const attrs = nft.raw.metadata.attributes || [];
                        let lvl = -1;

                        // Find Level Trait
                        for (const a of attrs) {
                            if (a.trait_type && (a.trait_type.toLowerCase().includes("level") || a.trait_type.toLowerCase().includes("lvl"))) {
                                lvl = parseInt(a.value);
                            }
                        }
                        
                        // If not in traits, check name
                        if (lvl === -1 && nft.name) {
                            const m = nft.name.match(/Lvl\s?(\d+)/i) || nft.name.match(/Level\s?(\d+)/i);
                            if (m) lvl = parseInt(m[1]);
                        }

                        // Save if valid level and not found yet
                        if (lvl >= 1 && lvl <= 5 && !levelsFound[lvl]) {
                            levelsFound[lvl] = nft;
                            levelsCount++;
                        }
                    }

                    if (levelsCount >= 5) break; // Found all!
                    
                    pageKey = data.pageKey;
                    if (!pageKey) break; // End of collection
                }

                loader.style.display = 'none';

                // 3. Render Results Sorted 1-5
                for (let i = 1; i <= 5; i++) {
                    const nft = levelsFound[i];
                    if (nft) {
                        renderCard(listDiv, nft, i, floorEth, floorEth * ethPrice);
                    } else {
                        // Optional: Render a placeholder if a level is missing
                    }
                }

                if (levelsCount === 0) {
                    listDiv.innerHTML = "<div class='not-found-msg'>No traits found in scan range.</div>";
                }

            } catch (e) {
                console.error(e);
                loader.style.display = 'none';
                errorDiv.innerText = "Connection Error. Reload.";
                errorDiv.style.display = 'block';
            }
        }

        function renderCard(container, nft, level, ethPrice, usdPrice) {
            const imgUrl = nft.image?.cachedUrl || nft.image?.originalUrl || 'https://placehold.co/150x150?text=No+Img';
            const name = nft.name || `Chickenfish #${nft.tokenId}`;
            const link = `https://opensea.io/assets/base/${COLLECTION_ADDR}/${nft.tokenId}`;

            // Clean IPFS
            const finalImg = imgUrl.startsWith('ipfs://') ? imgUrl.replace('ipfs://', 'https://ipfs.io/ipfs/') : imgUrl;

            const html = `
            <div class="nft-card">
                <div class="level-badge">LEVEL ${level}</div>
                <img src="${finalImg}" class="nft-img" onerror="this.src='https://placehold.co/150x150?text=Err'">
                
                <div class="nft-info">
                    <div class="nft-header">
                        <div>
                            <div class="nft-name">${name}</div>
                            <div class="token-id">ID: ${nft.tokenId}</div>
                        </div>
                    </div>

                    <div>
                        <div class="price-label">Collection Floor</div>
                        <div class="price-row">
                            <span class="price-eth">${ethPrice.toFixed(4)} Ξ</span>
                            <span class="price-usd">$${usdPrice.toFixed(2)}</span>
                        </div>
                    </div>

                    <a href="${link}" target="_blank" class="action-btn">View on OpenSea ↗</a>
                </div>
            </div>`;

            container.innerHTML += html;
        }
    </script>
</body>
</html>
