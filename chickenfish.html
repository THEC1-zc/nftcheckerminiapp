<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chickenfish Market</title>
    
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        const run = async () => { await sdk.actions.ready(); };
        run();
    </script>

    <style>
        :root { --primary: #FFC107; --accent: #FF9800; --bg: #fffbf0; --card-bg: #ffffff; --text: #3e2723; --green: #2ecc71; --purple: #9b59b6; --red: #e74c3c; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg);
            color: var(--text); 
            padding: 15px; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-x: hidden; 
        }
        
        .nav-header { width: 100%; max-width: 600px; display: flex; margin-bottom: 20px; justify-content: space-between; align-items: center;}
        .back-btn { text-decoration: none; color: #5d4037; font-weight: 600; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; }
        
        .container { width: 100%; max-width: 600px; box-sizing: border-box; }

        h2 { text-align: center; margin-top: 0; font-weight: 900; color: var(--text); margin-bottom: 5px; font-size: 1.8rem; }
        .subtitle { text-align: center; color: #795548; font-size: 0.9rem; margin-bottom: 25px; }

        .status-bar { 
            width: 100%; max-width: 400px; background: #fff; padding: 10px; 
            border-radius: 12px; font-size: 0.8rem; color: #888; text-align: center;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .status-active { color: var(--accent); font-weight: 700; }

        /* NFT LIST */
        .nft-list { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        
        .nft-card { 
            background: #fff; border: 1px solid #efebe9; border-radius: 16px; overflow: hidden; 
            box-shadow: 0 5px 15px rgba(62, 39, 35, 0.06); transition: transform 0.2s;
            display: flex; flex-direction: row; height: 130px; position: relative; opacity: 0; animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .level-badge {
            position: absolute; top: 8px; left: 8px; z-index: 2;
            background: rgba(0,0,0,0.8); color: white; padding: 3px 8px;
            border-radius: 6px; font-size: 0.65rem; font-weight: 800; backdrop-filter: blur(4px);
        }

        .rep-badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px; 
            font-size: 0.6rem; font-weight: 700; margin-top: 4px;
        }
        .rep-ok { background: #e8f5e9; color: var(--green); border: 1px solid #c8e6c9; }
        .rep-whale { background: #f3e5f5; color: var(--purple); border: 1px solid #e1bee7; }

        .nft-img { width: 130px; height: 130px; object-fit: cover; flex-shrink: 0; background: #fff8e1; }
        
        .nft-info { padding: 12px 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box; }
        
        .nft-name { font-weight: 900; font-size: 1rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .token-id { font-size: 0.7rem; color: #a1887f; font-family: monospace; }
        
        .price-label { font-size: 0.6rem; text-transform: uppercase; color: #bbb; font-weight: 700; margin-bottom: 2px; }
        .price-row { display: flex; align-items: baseline; gap: 6px; }
        .price-eth { font-size: 1.1rem; font-weight: 900; color: var(--accent); }
        .price-usd { font-size: 0.8rem; color: #8d6e63; font-weight: 500; }
        
        .action-btn {
            text-decoration: none; background: #3e2723; color: white; 
            padding: 8px 0; border-radius: 8px; font-weight: 700; font-size: 0.8rem;
            text-align: center; display: block; width: 100%; margin-top: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .action-btn:hover { background: var(--accent); }

        /* Fallback Card */
        .fallback-card {
            border: 2px dashed #ddd; background: #fafafa;
            display: flex; align-items: center; justify-content: center;
            height: 80px; border-radius: 16px; color: #aaa; font-size: 0.9rem;
        }
        
        .version-tag { text-align: center; font-size: 0.7rem; color: #8d6e63; margin-top: 25px; font-weight: 800; font-family: monospace; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="nav-header">
        <a href="index.html" class="back-btn">⬅ Home</a>
    </div>

    <div class="container">
        <h2>Chickenfish Market</h2>
        <div class="subtitle">Live Listings by Level (1-5)</div>

        <div id="statusBar" class="status-bar">Initializing...</div>

        <div id="list" class="nft-list"></div>
        
        <div class="version-tag">v4.0 (Surgical Strike)</div>
    </div>

    <script>
        const COLLECTION_ADDR = "0x84eea2be67b17698b0e09b57eeeda47aa921bbf0".toLowerCase();
        const ALCHEMY_KEY = '46kIRKE_HvuVkuRbPNRbh'; 
        
        // Use AllOrigins Proxy to bypass CORS on Reservoir
        const PROXY_BASE = "https://api.allorigins.win/raw?url=";
        const RESERVOIR_BASE = "https://api-base.reservoir.tools/tokens/v6";

        let ethPrice = 0;

        window.addEventListener('DOMContentLoaded', startSurgicalStrike);

        async function startSurgicalStrike() {
            const statusBar = document.getElementById('statusBar');
            const listDiv = document.getElementById('list');

            // 1. Get ETH Price first (Silent)
            try {
                const priceRes = await fetch("https://api.coinbase.com/v2/prices/ETH-USD/spot");
                const priceJson = await priceRes.json();
                ethPrice = parseFloat(priceJson.data.amount);
            } catch(e) { console.warn("ETH Price failed"); }

            // 2. Loop through Levels 1 to 5 SEQUENTIALLY
            for (let i = 1; i <= 5; i++) {
                statusBar.innerHTML = `Hunting for <span class="status-active">Level ${i}</span>...`;
                
                try {
                    const deal = await findBestDealForLevel(i);
                    if (deal) {
                        renderCard(listDiv, deal, i);
                    } else {
                        renderFallback(listDiv, i, "No valid listings found");
                    }
                } catch (err) {
                    console.error(`Level ${i} failed:`, err);
                    renderFallback(listDiv, i, "Data Unavailable");
                }
            }

            statusBar.innerText = "Scan Complete ✅";
        }

        async function findBestDealForLevel(level) {
            // Targeted Query: Only get items of this specific Level
            const params = new URLSearchParams({
                collection: COLLECTION_ADDR,
                sortBy: "floorAskPrice",
                limit: "8", // Get top 8 cheapest to check Rep
                "attributes[Level]": level, // THE MAGIC FILTER
                includeAttributes: "true"
            });

            const targetUrl = `${RESERVOIR_BASE}?${params.toString()}`;
            const proxyUrl = PROXY_BASE + encodeURIComponent(targetUrl);

            const res = await fetch(proxyUrl);
            if (!res.ok) return null;
            const data = await res.json();

            if (!data.tokens || data.tokens.length === 0) return null;

            // Analyze Candidates
            for (const item of data.tokens) {
                if (!item.market?.floorAsk?.price?.amount?.native) continue;

                const price = item.market.floorAsk.price.amount.native;
                const maker = item.market.floorAsk.maker;
                const token = item.token;

                // Check Rep
                let neynarScore = -1;
                const attrs = token.attributes || [];
                for (const a of attrs) {
                    const key = (a.key || "").toLowerCase();
                    if (key.includes("neynar") || key.includes("score")) neynarScore = parseFloat(a.value);
                }

                let reason = null;
                if (neynarScore > 0.69) {
                    reason = `Rep Score ${neynarScore}`;
                } else {
                    // Whale Check
                    const isWhale = await checkSellerWallet(maker);
                    if (isWhale) reason = "Whale Seller";
                }

                // If approved, return immediately (since it's the cheapest valid one)
                if (reason) {
                    return {
                        tokenId: token.tokenId,
                        name: token.name || `Chickenfish #${token.tokenId}`,
                        image: token.image,
                        price: price,
                        reason: reason
                    };
                }
            }
            return null; // None of the top 8 passed the check
        }

        async function checkSellerWallet(walletAddr) {
            try {
                const url = `https://base-mainnet.g.alchemy.com/nft/v3/${ALCHEMY_KEY}/getNFTsForOwner?owner=${walletAddr}&contractAddresses[]=${COLLECTION_ADDR}&withMetadata=true`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.ownedNfts) return false;
                
                // Check for Level 3+
                for (const item of data.ownedNfts) {
                    const attrs = item.raw.metadata.attributes || [];
                    const lvlAttr = attrs.find(a => a.trait_type && (a.trait_type.toLowerCase().includes("level")));
                    if (lvlAttr && parseInt(lvlAttr.value) >= 3) return true;
                }
                return false;
            } catch (err) { return false; }
        }

        function renderCard(container, data, level) {
            let imgUrl = data.image || 'https://placehold.co/150x150?text=No+Img';
            // Simple IPFS fix
            if (imgUrl.includes("ipfs") && !imgUrl.startsWith("http")) {
                 imgUrl = `https://ipfs.io/ipfs/${imgUrl.replace("ipfs://", "")}`;
            }
            
            const badgeClass = data.reason.includes("Score") ? "rep-ok" : "rep-whale";
            const usdVal = data.price * ethPrice;
            const link = `https://opensea.io/assets/base/${COLLECTION_ADDR}/${data.tokenId}`;

            const html = `
            <div class="nft-card">
                <div class="level-badge">LEVEL ${level}</div>
                <img src="${imgUrl}" class="nft-img" onerror="this.src='https://placehold.co/150x150?text=Err'">
                
                <div class="nft-info">
                    <div>
                        <div class="nft-name">${data.name}</div>
                        <div class="token-id">ID: ${data.tokenId}</div>
                        <div class="rep-badge ${badgeClass}">${data.reason}</div>
                    </div>

                    <div>
                        <div class="price-label">Listing Price</div>
                        <div class="price-row">
                            <span class="price-eth">${data.price.toFixed(4)} ETH</span>
                            <span class="price-usd">$${usdVal.toFixed(2)}</span>
                        </div>
                    </div>

                    <a href="${link}" target="_blank" class="action-btn">Buy on OpenSea ↗</a>
                </div>
            </div>`;

            container.innerHTML += html;
        }

        function renderFallback(container, level, msg) {
            // Direct link to OpenSea filtered by Level trait as fallback
            // Note: Trait filter params on OpenSea are complex, linking to general collection
            const link = `https://opensea.io/collection/chickenfish?search[stringTraits][0][name]=Level&search[stringTraits][0][values][0]=${level}&search[sortAscending]=true&search[sortBy]=UNIT_PRICE`;
            
            const html = `
            <div class="nft-card" style="height: 100px; justify-content: center; background: #fafafa; border: 2px dashed #eee;">
                <div style="text-align:center;">
                    <div style="font-weight:800; color:#ccc; font-size: 1rem;">LEVEL ${level}</div>
                    <div style="font-size:0.75rem; color:#aaa; margin-bottom:5px;">${msg}</div>
                    <a href="${link}" target="_blank" style="font-size:0.7rem; color:#3e2723; text-decoration:underline;">Check OpenSea manually</a>
                </div>
            </div>`;
            container.innerHTML += html;
        }
    </script>
</body>
</html>
