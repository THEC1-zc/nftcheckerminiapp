<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chickenfish Market</title>
    
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        const run = async () => { await sdk.actions.ready(); };
        run();
    </script>

    <style>
        :root { --primary: #FFC107; --accent: #FF9800; --bg: #fffbf0; --card-bg: #ffffff; --text: #3e2723; --green: #2ecc71; --purple: #9b59b6; --red: #e74c3c; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg);
            color: var(--text); 
            padding: 15px; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-x: hidden; 
        }
        
        .nav-header { width: 100%; max-width: 600px; display: flex; margin-bottom: 20px; justify-content: space-between; align-items: center;}
        .back-btn { text-decoration: none; color: #5d4037; font-weight: 600; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; }
        
        .container { width: 100%; max-width: 600px; box-sizing: border-box; }

        h2 { text-align: center; margin-top: 0; font-weight: 900; color: var(--text); margin-bottom: 5px; font-size: 1.8rem; }
        .subtitle { text-align: center; color: #795548; font-size: 0.9rem; margin-bottom: 25px; }

        .loading-spinner { 
            border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { text-align: center; color: #888; font-size: 0.8rem; margin-top: 10px; }

        /* GRID SYSTEM */
        .nft-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 500px) { .nft-grid { grid-template-columns: 1fr 1fr; } }
        
        .nft-card { 
            background: #fff; border: 1px solid #efebe9; border-radius: 20px; overflow: hidden; 
            box-shadow: 0 8px 20px rgba(62, 39, 35, 0.08); transition: transform 0.2s;
            display: flex; flex-direction: column; position: relative;
        }
        .nft-card:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(62, 39, 35, 0.12); }

        /* BADGES */
        .badge-container { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 2; }
        
        .rank-badge {
            background: rgba(0,0,0,0.7); color: white;
            padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 800;
            backdrop-filter: blur(4px); width: fit-content;
        }
        
        .reason-badge {
            padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px; width: fit-content; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .reason-high-score { background: var(--green); color: white; }
        .reason-whale { background: var(--purple); color: white; }
        .reason-backup { background: #7f8c8d; color: white; }

        .nft-img-container { width: 100%; aspect-ratio: 1/1; background: #fff8e1; overflow: hidden; position: relative; }
        .nft-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .nft-card:hover .nft-img { transform: scale(1.05); }
        
        .nft-info { padding: 15px; display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
        
        .trait-info { font-size: 0.75rem; color: #8d6e63; font-weight: 600; display: flex; justify-content: space-between; }
        .nft-name { font-weight: 900; font-size: 1.1rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .nft-price-box { 
            margin-top: auto; padding-top: 15px; border-top: 2px dashed #efebe9;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .price-val { font-size: 1.3rem; font-weight: 900; color: var(--accent); }
        .price-usd { font-size: 0.9rem; color: #a1887f; font-weight: 500; }
        
        .buy-btn { 
            margin-top: 15px; text-decoration: none; background-color: #3e2723; color: white; 
            text-align: center; padding: 12px; border-radius: 12px; font-weight: 700; font-size: 0.9rem;
            transition: background 0.2s; display: block;
        }
        .buy-btn:hover { background-color: var(--accent); }

        .fallback-warning { 
            background: #fff3cd; color: #856404; border: 1px solid #ffeeba; 
            padding: 10px; border-radius: 10px; font-size: 0.8rem; text-align: center; 
            margin-bottom: 20px; display: none; 
        }

        .version-tag { text-align: center; font-size: 0.7rem; color: #8d6e63; margin-top: 25px; font-weight: 800; font-family: monospace; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="nav-header">
        <a href="index.html" class="back-btn">‚¨Ö Home</a>
    </div>

    <div class="container">
        <h2>Chickenfish Market</h2>
        <div class="subtitle">Smart Sweeper ‚Ä¢ Rep > 0.69 or Whale Backup</div>

        <div id="loader">
            <div class="loading-spinner"></div>
            <div class="loading-text">Scanning Market...</div>
        </div>
        
        <div id="fallbackMsg" class="fallback-warning">‚ö†Ô∏è Filters unavailable (Proxy blocked). Showing General Floor Price.</div>

        <div id="grid" class="nft-grid"></div>
        
        <div class="version-tag">v2.3 (Resilience)</div>
    </div>

    <script>
        const COLLECTION_ADDR = "0x84eea2be67b17698b0e09b57eeeda47aa921bbf0".toLowerCase();
        const ALCHEMY_KEY = '46kIRKE_HvuVkuRbPNRbh'; 

        // Strategy A: CodeTabs Proxy (Different from previous failing ones)
        const PROXY_BASE = "https://api.codetabs.com/v1/proxy?quest=";
        const RESERVOIR_API = `https://api-base.reservoir.tools/tokens/v6?collection=${COLLECTION_ADDR}&sortBy=floorAskPrice&limit=25&includeAttributes=true`;

        window.addEventListener('DOMContentLoaded', initMarket);

        async function initMarket() {
            try {
                // Try Advanced Filter First
                await fetchSmartShowroom();
            } catch (e) {
                console.warn("Smart Filter Failed, switching to Alchemy Fallback:", e);
                // If it fails, load the generic floor
                await loadAlchemyFallback();
            }
        }

        async function fetchSmartShowroom() {
            const grid = document.getElementById('grid');
            const loader = document.getElementById('loader');
            const loadingText = document.querySelector('.loading-text');

            const targetUrl = PROXY_BASE + encodeURIComponent(RESERVOIR_API);
            
            // Set a timeout to fail fast if proxy hangs
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 6000); // 6s timeout

            const res = await fetch(targetUrl, { signal: controller.signal });
            clearTimeout(timeoutId);

            if (!res.ok) throw new Error(`Proxy Error: ${res.status}`);
            const data = await res.json();

            if(!data.tokens || data.tokens.length === 0) throw new Error("Empty API Response");

            const candidates = [];
            let checkedCount = 0;

            for (const item of data.tokens) {
                checkedCount++;
                loadingText.innerText = `Analyzing Item ${checkedCount}...`;

                if (!item.market?.floorAsk?.price?.amount?.native) continue;

                const attributes = item.token.attributes || [];
                let level = -1; 
                let neynarScore = -1; 

                // Universal Trait Hunt
                for (const attr of attributes) {
                    const key = (attr.key || "").toLowerCase();
                    const val = attr.value;
                    if (key.includes("level") || key.includes("lvl")) level = parseInt(val) || -1;
                    if (key.includes("neynar") || key.includes("score")) neynarScore = parseFloat(val) || -1;
                }

                // Filter 1: Level 1-5
                if (level < 1 || level > 5) continue;

                // Filter 2: Reputation
                let approvedReason = null;
                if (neynarScore > 0.69) {
                    approvedReason = "high-score";
                } else {
                    const seller = item.market.floorAsk.maker;
                    if (candidates.length < 3) {
                        const isWhale = await checkSellerWallet(seller);
                        if (isWhale) approvedReason = "whale-seller";
                    }
                }

                if (approvedReason) {
                    candidates.push({
                        token: item.token,
                        market: item.market,
                        level: level,
                        score: neynarScore === -1 ? "?" : neynarScore,
                        reason: approvedReason
                    });
                }
                if (candidates.length >= 3) break;
            }

            if(candidates.length === 0) throw new Error("No items matched criteria");

            loader.style.display = 'none';
            let rank = 1;
            candidates.forEach(item => {
                renderCard(grid, item, rank);
                rank++;
            });
        }

        // FALLBACK: If Proxy fails, use Alchemy to show at least the floor
        async function loadAlchemyFallback() {
            const grid = document.getElementById('grid');
            const loader = document.getElementById('loader');
            const fallbackMsg = document.getElementById('fallbackMsg');
            
            fallbackMsg.style.display = 'block';

            // 1. Get Metadata
            const metaUrl = `https://base-mainnet.g.alchemy.com/nft/v3/${ALCHEMY_KEY}/getContractMetadata?contractAddress=${COLLECTION_ADDR}`;
            const metaRes = await fetch(metaUrl);
            const metaData = await metaRes.json();
            
            // 2. Get Floor Price
            const floorUrl = `https://base-mainnet.g.alchemy.com/nft/v3/${ALCHEMY_KEY}/getFloorPrice?contractAddress=${COLLECTION_ADDR}`;
            const floorRes = await fetch(floorUrl);
            const floorData = await floorRes.json();

            // 3. Get ETH Price
            const priceRes = await fetch("https://api.coinbase.com/v2/prices/ETH-USD/spot");
            const priceJson = await priceRes.json();
            const ethPrice = parseFloat(priceJson.data.amount);

            const floorEth = floorData.openSea?.floorPrice || 0;
            const floorUsd = floorEth * ethPrice;
            const imgUrl = metaData.openSea?.imageUrl || "https://placehold.co/400x400?text=Floor";

            loader.style.display = 'none';

            // Render a Generic Floor Card
            const html = `
            <div class="nft-card">
                <div class="badge-container">
                    <div class="rank-badge">General Floor</div>
                    <div class="reason-badge reason-backup">‚ö†Ô∏è Filter Offline</div>
                </div>
                <div class="nft-img-container">
                    <img src="${imgUrl}" class="nft-img">
                </div>
                <div class="nft-info">
                    <div class="nft-name">${metaData.name || "Collection"}</div>
                    <div class="trait-info">
                        <span>Check details on OpenSea</span>
                    </div>
                    <div class="nft-price-box">
                        <div class="price-val">${floorEth.toFixed(4)} Œû</div>
                        <div class="price-usd">$${floorUsd.toFixed(2)}</div>
                    </div>
                    <a href="https://opensea.io/collection/chickenfish?search[sortAscending]=true&search[sortBy]=UNIT_PRICE" target="_blank" class="buy-btn">View Collection ‚Üó</a>
                </div>
            </div>`;
            
            grid.innerHTML = html;
        }

        async function checkSellerWallet(walletAddr) {
            try {
                const url = `https://base-mainnet.g.alchemy.com/nft/v3/${ALCHEMY_KEY}/getNFTsForOwner?owner=${walletAddr}&contractAddresses[]=${COLLECTION_ADDR}&withMetadata=true`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.ownedNfts) return false;
                for (const nft of data.ownedNfts) {
                    const attrs = nft.raw.metadata.attributes || [];
                    const lvlAttr = attrs.find(a => a.trait_type && (a.trait_type.toLowerCase().includes("level")));
                    if (lvlAttr && parseInt(lvlAttr.value) >= 3) return true; 
                }
                return false;
            } catch (err) { return false; }
        }

        function renderCard(container, data, rank) {
            const token = data.token;
            const market = data.market;
            const priceEth = market.floorAsk.price.amount.native;
            const priceUsd = market.floorAsk.price.amount.usd;
            const imgUrl = token.image || 'https://placehold.co/400x400?text=No+Img';
            
            let reasonBadge = data.reason === 'high-score' 
                ? `<div class="reason-badge reason-high-score">‚úÖ Rep Score ${data.score}</div>`
                : `<div class="reason-badge reason-whale">üü£ Whale Seller</div>`;

            const openseaLink = `https://opensea.io/assets/base/${COLLECTION_ADDR}/${token.tokenId}`;

            container.innerHTML += `
            <div class="nft-card">
                <div class="badge-container">
                    <div class="rank-badge">#${rank} Deal</div>
                    ${reasonBadge}
                </div>
                <div class="nft-img-container">
                    <img src="${imgUrl}" class="nft-img" onerror="this.src='https://placehold.co/400x400?text=Err'">
                </div>
                <div class="nft-info">
                    <div class="nft-name">${token.name || `#${token.tokenId}`}</div>
                    <div class="trait-info">
                        <span>Lvl: <b>${data.level}</b></span>
                        <span>Score: <b>${data.score}</b></span>
                    </div>
                    <div class="nft-price-box">
                        <div class="price-val">${priceEth.toFixed(4)} Œû</div>
                        <div class="price-usd">$${priceUsd.toFixed(2)}</div>
                    </div>
                    <a href="${openseaLink}" target="_blank" class="buy-btn">Buy on OpenSea ‚Üó</a>
                </div>
            </div>`;
        }
    </script>
</body>
</html>
