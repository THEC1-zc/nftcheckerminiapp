<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAST Analyzer 11.9 (Hotfix)</title>
    
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        const run = async () => { await sdk.actions.ready(); };
        run();
    </script>

    <style>
        :root { --primary: #0052FF; --bg: #f5f5f7; --card-bg: #ffffff; --text: #1a1a1a; --green: #2ecc71; --red: #ff4757; --orange: #ff9f43; --purple: #9c27b0; --dark: #34495e; --pink: #d63384; --cyan: #00bcd4; --indigo: #3f51b5; --fuchsia: #ff00ff; --teal: #16a085; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg);
            background-image: url('back.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--text); 
            padding: 15px; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-x: hidden; 
        }
        
        .nav-header { width: 100%; max-width: 600px; display: flex; margin-bottom: 20px; justify-content: space-between; align-items: center;}
        .back-btn { text-decoration: none; color: #666; font-weight: 600; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; }
        .wast-mini { font-weight: 900; font-size: 1rem; letter-spacing: 2px; color: var(--primary); margin-left: 10px; }
        
        .container { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.06); width: 100%; max-width: 600px; box-sizing: border-box; position: relative; }
        
        .input-group { margin-bottom: 15px; }
        label { display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.75rem; margin-bottom: 6px; color: #666; text-transform: uppercase; }
        
        .clear-link { color: white; background-color: var(--primary); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; text-decoration: none; font-weight: 700; box-shadow: 0 2px 5px rgba(0,82,255,0.2); transition: opacity 0.2s; }
        
        input, select { width: 100%; padding: 12px; border: 2px solid #e1e4e8; border-radius: 12px; font-size: 14px; outline: none; background: #fafafa; box-sizing: border-box; font-family: inherit; }
        
        .loading-text { font-size: 0.8rem; color: #999; font-style: italic; margin-top: 5px; display: none; text-align: center; }

        .btn-group { display: flex; gap: 8px; margin-top: 15px; width: 100%; flex-wrap: wrap; }
        button { flex: 1; border: none; padding: 12px; border-radius: 10px; font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: opacity 0.2s; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; min-width: 80px; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-fast { background-color: var(--primary); }
        .btn-full { background-color: var(--dark); }
        .btn-hist { background-color: var(--purple); display: none; } 
        .btn-moralis { background-color: var(--teal); display: none; } 
        .btn-copy { background-color: #27ae60; display: none; }
        .btn-test { background-color: #ff4757; width: 100%; margin-top: 5px; display: none; }

        .token-header { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; display: none; }
        .token-icon { width: 48px; height: 48px; border-radius: 50%; background: #eee; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .token-info h3 { margin: 0; font-size: 1.4rem; font-weight: 900; color: #333; line-height: 1; }
        .token-info span { font-size: 0.85rem; color: #666; font-weight: 500; }

        .dashboard-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; display: none; }
        .stat-card { background: #f8f9fa; padding: 12px; border-radius: 12px; border: 1px solid #eee; display: flex; flex-direction: column; }
        
        .stat-title { font-size: 0.8rem; text-transform: uppercase; font-weight: 900; margin-bottom: 6px; border-bottom: 2px solid #eee; padding-bottom: 4px; display: flex; justify-content: space-between; }
        
        .t-buy { color: var(--green); border-color: var(--green); }
        .t-sell { color: var(--red); border-color: var(--red); }
        .t-in { color: var(--purple); border-color: var(--purple); }
        .t-out { color: var(--orange); border-color: var(--orange); }
        .t-stake { color: var(--cyan); border-color: var(--cyan); }
        .t-unstake { color: var(--indigo); border-color: var(--indigo); }

        .stat-line { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 2px; font-family: monospace; color: #444; }
        .stat-line strong { font-weight: 700; color: #000; }
        .val-hist { color: var(--purple); }
        .val-curr { color: #666; }
        
        .filter-section { margin-top: 20px; display: none; }
        .filter-select { padding: 8px; border-radius: 8px; border: 1px solid #ddd; width: 100%; font-weight: 600; background: white; }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 10px; table-layout: fixed; }
        th { text-align: left; color: #999; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        td { padding: 12px 0; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .col-type { width: 35%; } .col-amount { width: 65%; text-align: right; }
        
        .tag { font-size: 0.6rem; padding: 3px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-right: 4px; display: inline-block; }
        .bg-buy { background: #e6fffa; color: var(--green); border: 1px solid #b2f5ea; }
        .bg-sell { background: #fff5f5; color: var(--red); border: 1px solid #fed7d7; }
        .bg-receive { background: #f3e5f5; color: var(--purple); border: 1px solid #e1bee7; }
        .bg-send { background: #fffaf0; color: var(--orange); border: 1px solid #feebc8; }
        .bg-stake { background: #e0f7fa; color: var(--cyan); border: 1px solid #b2ebf2; }
        .bg-unstake { background: #e8eaf6; color: var(--indigo); border: 1px solid #c5cae9; }
        .bg-pending { background: #eee; color: #999; border: 1px solid #ddd; }
        
        .tx-usd-row { font-size: 0.75rem; display: flex; justify-content: flex-end; gap: 5px; margin-top: 2px; align-items: center; }
        .curr-val { color: #666; font-weight: 500; }
        .hist-val { color: var(--purple); font-weight: 700; }
        .recent-val { color: var(--fuchsia); font-weight: 700; } 
        .var-val { font-size: 0.7rem; font-weight: 800; padding: 1px 4px; border-radius: 4px; }
        .var-pos { background: #e6fffa; color: var(--green); }
        .var-neg { background: #fff5f5; color: var(--red); }
        .var-neu { color: #ccc; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; display: none; }
        .page-btn { background: #fff; border: 1px solid #ddd; padding: 5px 15px; border-radius: 8px; cursor: pointer; color: #333; font-weight: 600; font-size: 0.8rem; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 0.8rem; color: #666; font-weight: 600; }

        #exportArea { margin-top: 15px; text-align: center; min-height: 40px; }
        #status { text-align: center; margin: 15px 0; font-weight: 600; font-size: 0.85rem; min-height: 20px; padding: 0 10px; }
        #deepStatus { font-size: 0.75rem; color: var(--primary); text-align: center; margin-bottom: 10px; display:none; }

        .wip-tag { text-align: center; font-size: 0.8rem; color: #ff4757; margin-top: 10px; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; border: 1px dashed #ff4757; padding: 5px; border-radius: 8px; background: #fff5f5; }
        .version-tag { text-align: center; font-size: 0.7rem; color: #0052FF; margin-top: 25px; font-weight: 800; font-family: monospace; opacity: 0.8; }
    </style>
</head>
<body>

    <div class="nav-header">
        <a href="index.html" class="back-btn">‚¨Ö Home <span class="wast-mini">WAST</span></a>
    </div>

    <div class="container">
        <h2 style="text-align:center; margin-top:0;">Master Analyzer</h2>
        <p style="text-align:center; color:#666; font-size:0.8rem; margin-bottom:20px;">Logic: v11.9 Buttons Fix</p>
        
        <div class="input-group">
            <label>Target Wallet <span id="btnChangeTarget" class="clear-link">Change üîÑ</span></label>
            <input type="text" id="walletInput" placeholder="0x..." />
        </div>

        <div class="input-group">
            <label>Token to Analyze <span id="toggleTokenMode" class="clear-link" style="background:#34495e;">Custom CA ‚úçÔ∏è</span></label>
            <div id="selectContainer"><select id="tokenSelect"><option value="" disabled selected>Waiting for wallet...</option></select><div id="loadingTokens" class="loading-text">Scanning...</div></div>
            <div id="inputContainer" style="display:none;"><input type="text" id="tokenInput" placeholder="Paste Token CA (0x...)" /></div>
        </div>

        <div class="btn-group">
            <button class="btn-fast" id="btnFast">‚ö° Last 500</button>
            <button class="btn-full" id="btnFull">üê¢ Deep (5k)</button>
            <button id="btnHistory" class="btn-hist">üîÆ Time Machine</button>
            <button id="btnMoralis" class="btn-moralis">‚ìÇÔ∏è Moralis (Test)</button>
            <button id="btnCopy" class="btn-copy">üìã Copy for Excel (*)</button>
        </div>
        <div class="btn-group">
            <button id="btnTest" class="btn-test">üß™ TEST (5 Txs)</button>
        </div>
        
        <div id="status"></div>
        <div id="deepStatus"></div>

        <div id="tokenHeader" class="token-header">
            <img id="tokenImg" src="" class="token-icon" onerror="this.src='https://placehold.co/48x48?text=?'">
            <div class="token-info">
                <h3 id="tokenSym">TOKEN</h3>
                <span id="tokenPrice">$0.00</span>
            </div>
        </div>

        <div id="dashboard" class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-title t-buy">BUY</div>
                <div class="stat-line"><span>Tokens:</span> <strong id="buyTokens">0</strong></div>
                <div class="stat-line"><span>Hist $:</span> <strong id="buyHist" class="val-hist">---</strong></div>
                <div class="stat-line"><span>Curr $:</span> <strong id="buyCurr" class="val-curr">$0.00</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-title t-sell">SELL</div>
                <div class="stat-line"><span>Tokens:</span> <strong id="sellTokens">0</strong></div>
                <div class="stat-line"><span>Hist $:</span> <strong id="sellHist" class="val-hist">---</strong></div>
                <div class="stat-line"><span>Curr $:</span> <strong id="sellCurr" class="val-curr">$0.00</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-title t-stake">STREAM STAKE (SUPERFLUID)</div>
                <div class="stat-line"><span>Tokens:</span> <strong id="stakeTokens">0</strong></div>
                <div class="stat-line"><span>Hist $:</span> <strong id="stakeHist" class="val-hist">---</strong></div>
                <div class="stat-line"><span>Curr $:</span> <strong id="stakeCurr" class="val-curr">$0.00</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-title t-unstake">STREAM UNSTAKE (SUPERFLUID)</div>
                <div class="stat-line"><span>Tokens:</span> <strong id="unstakeTokens">0</strong></div>
                <div class="stat-line"><span>Hist $:</span> <strong id="unstakeHist" class="val-hist">---</strong></div>
                <div class="stat-line"><span>Curr $:</span> <strong id="unstakeCurr" class="val-curr">$0.00</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-title t-in">RECEIVE (P2P / AIRDROP)</div>
                <div class="stat-line"><span>Tokens:</span> <strong id="recvTokens">0</strong></div>
                <div class="stat-line"><span>Hist $:</span> <strong id="recvHist" class="val-hist">---</strong></div>
                <div class="stat-line"><span>Curr $:</span> <strong id="recvCurr" class="val-curr">$0.00</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-title t-out">SEND (P2P / BURN)</div>
                <div class="stat-line"><span>Tokens:</span> <strong id="sendTokens">0</strong></div>
                <div class="stat-line"><span>Hist $:</span> <strong id="sendHist" class="val-hist">---</strong></div>
                <div class="stat-line"><span>Curr $:</span> <strong id="sendCurr" class="val-curr">$0.00</strong></div>
            </div>
        </div>

        <div id="filterContainer" class="filter-section">
            <label>Filter Transactions:</label>
            <select id="txFilter" class="filter-select">
                <option value="ALL">Show All</option>
                <option value="BUY">üü¢ Buys</option>
                <option value="SELL">üî¥ Sells</option>
                <option value="STAKE">üîµ Stream Stakes</option>
                <option value="UNSTAKE">üü£ Stream Unstakes</option>
                <option value="RECEIVE">üü£ Receives</option>
                <option value="SEND">üü† Sends</option>
            </select>
        </div>

        <table id="txTable" style="display:none;">
            <thead><tr><th class="col-type">Type / Date</th><th class="col-amount">Amount / Value</th></tr></thead>
            <tbody id="txList"></tbody>
        </table>

        <div id="paginationContainer" class="pagination">
            <button id="btnPrev" class="page-btn">Previous</button>
            <span id="pageIndicator" class="page-info">Page 1</span>
            <button id="btnNext" class="page-btn">Next</button>
        </div>

        <div class="wip-tag">üöß v11.9 HOTFIX üöß</div>
        <div class="version-tag">v11.9</div>
    </div>

    <script>
        const ALCHEMY_KEY = '46kIRKE_HvuVkuRbPNRbh'; 
        const MORALIS_KEY_INTEGRATED = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6ImMzYWFkNmIxLTUyYjMtNGNkZC1iZjBkLTE4MWM0ZDY1MTkzMiIsIm9yZ0lkIjoiNDkwNDE4IiwidXNlcklkIjoiNTA0NTc3IiwidHlwZUlkIjoiNTQwNjExMjgtMzY3Zi00MDQyLWE1NDItODdjMzlkODkxMDkzIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3Njg0MTI5MjMsImV4cCI6NDkyNDE3MjkyM30.wKcFrQ_mjxCe_bu1ylkPBb_VvQlBnkTklNggqmom1UU';
        const ADMIN_WALLET = '0xd29c790466675153A50DF7860B9EFDb689A21cDe'.toLowerCase();

        let globalEvents = []; 
        let currentTokenCA = "";
        let currentTokenSymbol = "TOKEN";
        let currentPricePerToken = 0; 
        let isCustomTokenMode = false;
        
        let currentPage = 1;
        const rowsPerPage = 50;
        const BATCH_SIZE = 15; 

        const LIQUID_ASSETS = [
            "0x833589fcd6edb6e08f4c7c32d4f71b54bda02913", 
            "0xfde4c96c8593536e31f229ea8f37b2adb8523a2a", 
            "0x60a3e35cc302bfa44cb288bc5a4f316fdb1adb42", 
            "0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca", 
            "0x4200000000000000000000000000000000000006", 
            "0x0000000000000000000000000000000000000000"
        ];

        const USDC_BASE = "0x833589fcd6edb6e08f4c7c32d4f71b54bda02913";
        const ETH_PSEUDO = "0x0000000000000000000000000000000000000000"; 
        const WETH_ADDR = "0x4200000000000000000000000000000000000006";

        const EVT_UPGRADE = "0x49755b9e9d962892997c0da9e7b243403a6094366c3c43494793db64f4347781";
        const EVT_DOWNGRADE = "0x24a737475a242040b2f0c74906f36934c264a4066922df674603946006e23293";
        const EVT_TRANSFER = "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef";

        window.addEventListener('DOMContentLoaded', () => {
            const myIdentity = localStorage.getItem('tysm_wallet');
            if(myIdentity) document.getElementById('walletInput').value = myIdentity;
            const wInput = document.getElementById('walletInput');
            if(wInput.value) loadUserTokens(wInput.value);
        });

        document.getElementById('walletInput').addEventListener('change', (e) => {
            if(e.target.value.trim().startsWith('0x')) loadUserTokens(e.target.value.trim());
        });
        document.getElementById('btnChangeTarget').addEventListener('click', () => {
            document.getElementById('walletInput').value = "";
            document.getElementById('tokenSelect').innerHTML = '<option disabled selected>Waiting...</option>';
        });
        document.getElementById('toggleTokenMode').addEventListener('click', () => {
            const s = document.getElementById('selectContainer'), i = document.getElementById('inputContainer');
            if(s.style.display==='none'){s.style.display='block';i.style.display='none';isCustomTokenMode=false;}
            else{s.style.display='none';i.style.display='block';isCustomTokenMode=true;}
        });
        document.getElementById('tokenSelect').addEventListener('change', (e) => {
            document.getElementById('tokenInput').value = e.target.value;
        });
        document.getElementById('txFilter').addEventListener('change', () => { currentPage=1; renderTable(); });
        document.getElementById('btnPrev').addEventListener('click', () => { if(currentPage>1) {currentPage--; renderTable();} });
        document.getElementById('btnNext').addEventListener('click', () => { currentPage++; renderTable(); });

        async function loadUserTokens(walletAddr) {
            const select = document.getElementById('tokenSelect');
            const loading = document.getElementById('loadingTokens');
            select.style.display = 'none'; loading.style.display = 'block'; select.innerHTML = '';

            try {
                let allTokens = [];
                let pageKey = null;
                let loopCount = 0;
                do {
                    if(loopCount > 30) break; 
                    const params = { "id": 1, "jsonrpc": "2.0", "method": "alchemy_getTokenBalances", "params": [walletAddr] };
                    if(pageKey) params.params[0].pageKey = pageKey;
                    const res = await fetch(`https://base-mainnet.g.alchemy.com/v2/${ALCHEMY_KEY}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(params)});
                    const data = await res.json();
                    if(data.result?.tokenBalances) allTokens = allTokens.concat(data.result.tokenBalances);
                    pageKey = data.result?.pageKey;
                    loopCount++;
                } while (pageKey);

                let tokens = allTokens.filter(t => t.tokenBalance !== "0x0000000000000000000000000000000000000000000000000000000000000000");
                const ethRes = await fetch(`https://base-mainnet.g.alchemy.com/v2/${ALCHEMY_KEY}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ "id": 1, "jsonrpc": "2.0", "method": "eth_getBalance", "params": [walletAddr, "latest"] }) });
                const ethData = await ethRes.json();
                if(ethData.result && ethData.result !== "0x0") tokens.push({ contractAddress: ETH_PSEUDO, tokenBalance: ethData.result });

                const uniqueMap = new Map();
                for(const t of tokens) uniqueMap.set(t.contractAddress.toLowerCase(), t);
                tokens = Array.from(uniqueMap.values());

                loading.innerText = `Indexing ${tokens.length} tokens...`;
                const pricedTokens = [];
                const chunks = [];
                for (let i=0; i<tokens.length; i+=30) chunks.push(tokens.slice(i, i+30));

                for(const chunk of chunks) {
                    const queryAddrs = chunk.map(t => t.contractAddress === ETH_PSEUDO ? WETH_ADDR : t.contractAddress).join(',');
                    try {
                        const dexRes = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${queryAddrs}`);
                        const dexData = await dexRes.json();
                        chunk.forEach(t => {
                            const lcAddr = t.contractAddress.toLowerCase();
                            const pair = dexData.pairs ? dexData.pairs.find(p => p.baseToken.address.toLowerCase() === (lcAddr === ETH_PSEUDO ? WETH_ADDR : lcAddr)) : null;
                            const decimals = 18; 
                            const bal = Number(BigInt(t.tokenBalance)) / (10**decimals);
                            
                            let price = pair ? parseFloat(pair.priceUsd) : 0;
                            if(lcAddr === USDC_BASE) price = 1.0;
                            if(price === 0 && (lcAddr === ETH_PSEUDO || lcAddr === WETH_ADDR)) price = 2500; 

                            const sym = pair ? pair.baseToken.symbol : (lcAddr === ETH_PSEUDO ? "ETH" : t.contractAddress.slice(0,6));
                            pricedTokens.push({ ca: t.contractAddress, symbol: sym, bal: bal, usd: bal * price });
                        });
                    } catch(e) {}
                    await new Promise(r=>setTimeout(r, 100));
                }

                pricedTokens.sort((a,b) => b.usd - a.usd);
                const valued = pricedTokens.filter(t => t.usd > 0.01);
                const others = pricedTokens.filter(t => t.usd <= 0.01);

                select.innerHTML = '<option value="" disabled selected>Select a token...</option>';
                if(valued.length>0) {
                    const grp = document.createElement('optgroup'); grp.label="üí≤ VALUED ASSETS";
                    valued.forEach(t => { 
                        const o = document.createElement('option'); o.value = t.ca; 
                        o.innerText = `${t.symbol} - $${t.usd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
                        grp.appendChild(o);
                    });
                    select.appendChild(grp);
                }
                if(others.length>0) {
                    const grp = document.createElement('optgroup'); grp.label="‚ùì OTHERS";
                    others.forEach(t => { 
                        const o = document.createElement('option'); o.value = t.ca; 
                        o.innerText = `${t.symbol} (${t.bal.toFixed(4)})`;
                        grp.appendChild(o);
                    });
                    select.appendChild(grp);
                }

            } catch(e) { console.error(e); select.innerHTML='<option disabled>Error</option>'; } 
            finally { loading.style.display='none'; select.style.display='block'; }
        }

        document.getElementById('btnFast').addEventListener('click', () => runAnalysis(500)); 
        document.getElementById('btnFull').addEventListener('click', () => runAnalysis(5000)); 
        document.getElementById('btnTest').addEventListener('click', () => runAnalysis(5));
        document.getElementById('btnHistory').addEventListener('click', fetchHistoricalPrices);
        document.getElementById('btnMoralis').addEventListener('click', fetchMoralisPrices);
        document.getElementById('btnCopy').addEventListener('click', copyToClipboard);

        async function runAnalysis(limit) {
            const wallet = document.getElementById('walletInput').value.trim().toLowerCase();
            currentTokenCA = isCustomTokenMode ? document.getElementById('tokenInput').value.trim().toLowerCase() : document.getElementById('tokenSelect').value.trim().toLowerCase();
            
            document.getElementById('dashboard').style.display='none';
            document.getElementById('txTable').style.display='none';
            document.getElementById('tokenHeader').style.display='none';
            document.getElementById('btnHistory').style.display='none';
            document.getElementById('btnMoralis').style.display='none';
            document.getElementById('btnCopy').style.display='none';
            document.getElementById('paginationContainer').style.display='none';
            document.getElementById('deepStatus').style.display='none';
            document.getElementById('btnHistory').innerText = "üîÆ Time Machine"; 
            document.getElementById('btnHistory').disabled = false;
            document.getElementById('txList').innerHTML = "";
            const status = document.getElementById('status');
            globalEvents = []; 
            currentPage = 1;

            if(!wallet.startsWith('0x') || !currentTokenCA.startsWith('0x')) return;

            status.innerText = "Initializing...";
            
            try {
                const dexRes = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${currentTokenCA}`);
                const dexData = await dexRes.json();
                if(dexData.pairs && dexData.pairs.length > 0) {
                    const pair = dexData.pairs.find(p=>p.chainId==='base');
                    currentPricePerToken = parseFloat(pair.priceUsd);
                    currentTokenSymbol = pair.baseToken.symbol;
                    document.getElementById('tokenSym').innerText = currentTokenSymbol;
                    document.getElementById('tokenPrice').innerText = `$${currentPricePerToken}`;
                    document.getElementById('tokenImg').src = pair.info?.imageUrl || `https://dd.dexscreener.com/ds-data/tokens/base/${currentTokenCA}.png`;
                    document.getElementById('tokenHeader').style.display = 'flex';
                }
            } catch(e){ currentPricePerToken = 0; }

            const rawTxs = await fetchUnifiedTransfers(wallet, currentTokenCA, limit, status);
            status.innerText = `Analyzing ${rawTxs.length} transactions...`;

            globalEvents = rawTxs.map(tx => {
                const myWallet = wallet.toLowerCase();
                const isIncoming = tx.to && tx.to.toLowerCase() === myWallet;
                const val = parseFloat(tx.value);
                const dateObj = new Date(tx.metadata.blockTimestamp);
                const date = dateObj.toLocaleDateString();
                const timestamp = Math.floor(dateObj.getTime() / 1000); 
                const category = isIncoming ? 'IN (Pend)' : 'OUT (Pend)'; 

                return {
                    hash: tx.hash,
                    block: parseInt(tx.blockNum, 16), 
                    ts: timestamp, 
                    amount: val,
                    date: date,
                    rowId: `tx-${tx.hash}`,
                    rawVal: val,
                    currVal: val * currentPricePerToken,
                    histVal: null,
                    histPrice: null, 
                    isRecentFallback: false,
                    type: category,
                    isIncoming: isIncoming
                };
            });

            document.getElementById('dashboard').style.display='flex';
            document.getElementById('filterContainer').style.display='block';
            document.getElementById('txTable').style.display='table';
            document.getElementById('paginationContainer').style.display='flex';
            document.getElementById('deepStatus').style.display='block';
            
            // SHOW BUTTONS IMMEDIATELY
            if(globalEvents.length > 0) {
                document.getElementById('btnHistory').style.display='flex';
                document.getElementById('btnMoralis').style.display='flex';
                document.getElementById('btnCopy').style.display='flex';
            }

            renderTable();
            refineDataInBackground(wallet, currentTokenCA);
        }

        async function refineDataInBackground(wallet, tokenCA) {
            const deepStatus = document.getElementById('deepStatus');
            const batchSize = BATCH_SIZE; 
            
            for (let i = 0; i < globalEvents.length; i += batchSize) {
                const batch = globalEvents.slice(i, i + batchSize);
                deepStatus.innerText = `Refining Data: ${Math.min(i + batchSize, globalEvents.length)} / ${globalEvents.length}...`;

                const requestBody = batch.map((evt, idx) => ({ jsonrpc: "2.0", id: idx, method: "eth_getTransactionReceipt", params: [evt.hash] }));

                try {
                    const res = await fetch(`https://base-mainnet.g.alchemy.com/v2/${ALCHEMY_KEY}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(requestBody)});
                    const responses = await res.json();

                    responses.forEach(r => {
                        if (!r.result) return;
                        const evtIndex = i + r.id; 
                        if (!globalEvents[evtIndex]) return;

                        const logs = r.result.logs;
                        const evt = globalEvents[evtIndex];
                        const myWallet = wallet.toLowerCase().replace("0x", "");
                        
                        let sentLiquid = false;
                        let receivedLiquid = false;
                        let isSF_Upgrade = false;
                        let isSF_Downgrade = false;

                        logs.forEach(log => {
                            if (log.topics[0] === EVT_UPGRADE) isSF_Upgrade = true;
                            if (log.topics[0] === EVT_DOWNGRADE) isSF_Downgrade = true;

                            if (log.topics[0] === EVT_TRANSFER) {
                                const contractAddr = log.address.toLowerCase();
                                const fromMe = log.topics[1] && log.topics[1].toLowerCase().includes(myWallet);
                                const toMe = log.topics[2] && log.topics[2].toLowerCase().includes(myWallet);

                                if (LIQUID_ASSETS.includes(contractAddr)) {
                                    if (fromMe) sentLiquid = true;
                                    if (toMe) receivedLiquid = true;
                                }
                            }
                        });

                        let newType = 'UNKNOWN';
                        if (isSF_Upgrade) { newType = 'STAKE'; }
                        else if (isSF_Downgrade) { newType = 'UNSTAKE'; }
                        else if (evt.isIncoming) { if (sentLiquid) newType = 'BUY'; else newType = 'RECEIVE'; }
                        else { if (receivedLiquid) newType = 'SELL'; else newType = 'SEND'; }

                        globalEvents[evtIndex].type = newType;
                    });
                } catch(e) { console.error("Batch fail", e); }
                await new Promise(r => setTimeout(r, 100)); 
                recalcAllTotals(); 
            }

            finalizePending(); 
            deepStatus.innerText = "Data Fully Refined ‚úÖ";
            document.getElementById('status').innerText = "Complete ‚úÖ";
            renderTable(); 
        }

        function finalizePending() {
            globalEvents.forEach(evt => {
                if(evt.type.includes('(Pend)')) {
                    if(evt.isIncoming) evt.type = 'RECEIVE';
                    else evt.type = 'SEND';
                }
            });
            recalcAllTotals();
        }

        function recalcAllTotals() {
            let t = { buy:0, sell:0, stake:0, unstake:0, recv:0, send:0, 
                      buyV:0, sellV:0, stakeV:0, unstakeV:0, recvV:0, sendV:0 };
            
            globalEvents.forEach(evt => {
                const val = evt.histVal || 0; 
                if(evt.type === 'BUY') { t.buy += evt.amount; t.buyV += val; }
                else if(evt.type === 'SELL') { t.sell += evt.amount; t.sellV += val; }
                else if(evt.type === 'STAKE') { t.stake += evt.amount; t.stakeV += val; }
                else if(evt.type === 'UNSTAKE') { t.unstake += evt.amount; t.unstakeV += val; }
                else if(evt.type === 'RECEIVE') { t.recv += evt.amount; t.recvV += val; }
                else if(evt.type === 'SEND') { t.send += evt.amount; t.sendV += val; }
            });

            const fmt = (n) => n.toLocaleString(undefined, {maximumFractionDigits:2});
            const fmtU = (n) => `$${(n * currentPricePerToken).toLocaleString(undefined, {maximumFractionDigits:2})}`;
            const fmtH = (n) => `$${n.toLocaleString(undefined, {maximumFractionDigits:2})}`;

            document.getElementById('buyTokens').innerText = fmt(t.buy); document.getElementById('buyCurr').innerText = fmtU(t.buy); document.getElementById('buyHist').innerText = t.buyV ? fmtH(t.buyV) : "---";
            document.getElementById('sellTokens').innerText = fmt(t.sell); document.getElementById('sellCurr').innerText = fmtU(t.sell); document.getElementById('sellHist').innerText = t.sellV ? fmtH(t.sellV) : "---";
            document.getElementById('stakeTokens').innerText = fmt(t.stake); document.getElementById('stakeCurr').innerText = fmtU(t.stake); document.getElementById('stakeHist').innerText = t.stakeV ? fmtH(t.stakeV) : "---";
            document.getElementById('unstakeTokens').innerText = fmt(t.unstake); document.getElementById('unstakeCurr').innerText = fmtU(t.unstake); document.getElementById('unstakeHist').innerText = t.unstakeV ? fmtH(t.unstakeV) : "---";
            document.getElementById('recvTokens').innerText = fmt(t.recv); document.getElementById('recvCurr').innerText = fmtU(t.recv); document.getElementById('recvHist').innerText = t.recvV ? fmtH(t.recvV) : "---";
            document.getElementById('sendTokens').innerText = fmt(t.send); document.getElementById('sendCurr').innerText = fmtU(t.send); document.getElementById('sendHist').innerText = t.sendV ? fmtH(t.sendV) : "---";
        }

        function renderTable() {
            const filter = document.getElementById('txFilter').value;
            const tbody = document.getElementById('txList');
            tbody.innerHTML = "";

            const filteredData = globalEvents.filter(evt => {
                if (filter === 'ALL') return true;
                if (filter === 'BUY' && (evt.type === 'BUY' || evt.type === 'IN (Pend)')) return true;
                if (filter === 'SELL' && (evt.type === 'SELL' || evt.type === 'OUT (Pend)')) return true;
                if (filter === 'STAKE' && evt.type === 'STAKE') return true;
                if (filter === 'UNSTAKE' && evt.type === 'UNSTAKE') return true;
                if (filter === 'RECEIVE' && (evt.type === 'RECEIVE' || evt.type === 'IN (Pend)')) return true;
                if (filter === 'SEND' && (evt.type === 'SEND' || evt.type === 'OUT (Pend)')) return true;
                return false;
            });

            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if(currentPage > totalPages) currentPage = totalPages;
            if(currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);

            let html = "";
            pageData.forEach(evt => {
                let badge = 'bg-pending';
                if(evt.type==='BUY') badge='bg-buy';
                else if(evt.type==='SELL') badge='bg-sell';
                else if(evt.type==='STAKE') badge='bg-stake';
                else if(evt.type==='UNSTAKE') badge='bg-unstake';
                else if(evt.type==='RECEIVE') badge='bg-receive';
                else if(evt.type==='SEND') badge='bg-send';

                const currHtml = `<div class="curr-val">Curr: $${evt.currVal.toLocaleString(undefined, {maximumFractionDigits:2})}</div>`;
                
                let histHtml = '<div class="hist-val" style="color:#ccc;">Hist: ---</div>';
                if(evt.histVal !== null) {
                    const colorClass = evt.isRecentFallback ? 'recent-val' : 'hist-val';
                    histHtml = `<div class="${colorClass}">Hist: $${evt.histVal.toLocaleString(undefined, {maximumFractionDigits:2})}</div>`;
                } else if (evt.histChecked) {
                    histHtml = `<div class="hist-val" style="color:#999;">Hist: N/A</div>`;
                }

                let varHtml = '<div class="var-val var-neu">Var: ---</div>';
                if(evt.histPrice > 0) {
                    const varPct = ((currentPricePerToken - evt.histPrice) / evt.histPrice) * 100;
                    const varClass = varPct >= 0 ? 'var-pos' : 'var-neg';
                    const sign = varPct >= 0 ? '+' : '';
                    varHtml = `<div class="var-val ${varClass}">Var: ${sign}${varPct.toFixed(1)}%</div>`;
                }

                html += `<tr id="${evt.rowId}">
                    <td class="col-type">
                        <span class="tag ${badge}">${evt.type}</span> <span style="color:#999;font-size:0.7em">${evt.date}</span>
                    </td>
                    <td class="col-amount">
                        <strong>${evt.rawVal.toLocaleString(undefined, {maximumFractionDigits:0})}</strong>
                        <div class="tx-usd-row">${currHtml}</div>
                        <div class="tx-usd-row">${histHtml}</div>
                        <div class="tx-usd-row">${varHtml}</div>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;

            document.getElementById('pageIndicator').innerText = `Page ${currentPage} of ${totalPages || 1}`;
            document.getElementById('btnPrev').disabled = (currentPage <= 1);
            document.getElementById('btnNext').disabled = (currentPage >= totalPages);
        }

        async function fetchHistoricalPrices() {
            const btn = document.getElementById('btnHistory');
            const status = document.getElementById('status');
            btn.disabled = true;
            btn.innerText = "‚è≥ Running...";
            
            let processed = 0;
            
            for(const evt of globalEvents) {
                try {
                    status.innerText = `Fetching ${processed+1}/${globalEvents.length}...`;
                    let histPrice = null;
                    evt.isRecentFallback = false;
                    
                    try {
                        const res = await fetch(`https://coins.llama.fi/prices/historical/${evt.ts}/base:${currentTokenCA.toLowerCase()}`);
                        const data = await res.json();
                        const key = `base:${currentTokenCA.toLowerCase()}`;
                        if(data.coins && data.coins[key]) histPrice = data.coins[key].price;
                    } catch(e){}

                    if(histPrice === null) {
                        try {
                            const mRes = await fetch(`https://api.mobula.io/api/1/market/history?asset=${currentTokenCA}&blockchain=base&from=${evt.ts - 3600}&to=${evt.ts + 3600}`);
                            const mData = await mRes.json();
                            if(mData.data && mData.data.price_history && mData.data.price_history.length > 0) histPrice = mData.data.price_history[0][1];
                        } catch(e){}
                    }

                    if(histPrice === null && (Date.now()/1000 - evt.ts) < 86400) {
                        histPrice = currentPricePerToken;
                        evt.isRecentFallback = true;
                    }

                    if(histPrice !== null) {
                        evt.histVal = evt.amount * histPrice; 
                        evt.histPrice = histPrice;
                        recalcAllTotals(); 
                    } else { evt.histChecked = true; }

                    processed++;
                    if(processed % 5 === 0) renderTable();
                    await new Promise(r => setTimeout(r, 200)); 
                } catch(e) { console.log(e); evt.histChecked=true; }
            }
            renderTable();
            status.innerText = "History Updated üìú";
            btn.innerHTML = "‚úÖ Time Machine";
        }

        async function fetchMoralisPrices() {
            const loggedWallet = localStorage.getItem('tysm_wallet');
            const normLogged = loggedWallet ? loggedWallet.toLowerCase() : "";
            let keyToUse = '';

            if (normLogged === ADMIN_WALLET) {
                keyToUse = MORALIS_KEY_INTEGRATED;
            } else {
                keyToUse = prompt("Insert your own Moralis API Key:");
                if (!keyToUse) return;
            }

            const btn = document.getElementById('btnMoralis');
            const status = document.getElementById('status');
            btn.disabled = true;
            btn.innerText = "‚ìÇÔ∏è Running...";
            
            let processed = 0;
            for(const evt of globalEvents) {
                if (evt.histPrice !== null && !evt.isRecentFallback) continue; // SKIP

                try {
                    status.innerText = `Moralis Check ${processed+1}...`;
                    const url = `https://deep-index.moralis.io/api/v2.2/erc20/${currentTokenCA}/price?chain=base&to_block=${evt.block}`;
                    const res = await fetch(url, { headers: { "X-API-Key": keyToUse, "accept": "application/json" } });
                    const data = await res.json();
                    
                    if(data.usdPrice) {
                        const histPrice = data.usdPrice;
                        evt.histPrice = histPrice;
                        evt.histVal = evt.amount * histPrice;
                        evt.isRecentFallback = false; 
                        recalcAllTotals(); 
                    }
                    processed++;
                    if(processed % 2 === 0) renderTable(); 
                    await new Promise(r => setTimeout(r, 250)); 
                } catch(e){ console.log(e); }
            }
            renderTable();
            status.innerText = "Moralis Check Done ‚ìÇÔ∏è";
            btn.innerHTML = "‚úÖ Moralis Done";
        }

        function copyToClipboard() {
            const toIt = (n) => n.toFixed(2).replace('.', ',');
            let csvContent = "";
            csvContent += `Data * Tipo * Token * Quantit√† * Valore Storico * Valore Attuale * Hash\n`;
            globalEvents.forEach(evt => {
                const hVal = evt.histVal ? evt.histVal.toFixed(2).replace('.', ',') : "0,00";
                const cVal = evt.currVal ? evt.currVal.toFixed(2).replace('.', ',') : "0,00";
                const qty = evt.amount.toFixed(4).replace('.', ',');
                csvContent += `${evt.date} * ${evt.type} * ${currentTokenSymbol} * ${qty} * ${hVal} * ${cVal} * ${evt.hash}\n`;
            });
            navigator.clipboard.writeText(csvContent).then(() => {
                const btn = document.getElementById('btnCopy');
                const orig = btn.innerText;
                btn.innerText = "‚úÖ COPIED!";
                setTimeout(() => btn.innerText = orig, 2000);
            });
        }

        async function fetchUnifiedTransfers(wallet, token, limit, statusElement) {
            let accumulated = [];
            const fetchDir = async (isIncoming) => {
                let list = [];
                let pageKey = null;
                let loops = 0;
                do {
                    if(list.length >= limit || loops > 15) break;
                    const params = { "fromBlock": "0x0", "toBlock": "latest", "category": ["erc20"], "withMetadata": true, "excludeZeroValue": true, "contractAddresses": [token], "order": "desc", "maxCount": "0x3e8" };
                    if(isIncoming) params.toAddress = wallet; else params.fromAddress = wallet;
                    if(pageKey) params.pageKey = pageKey;
                    const res = await fetch(`https://base-mainnet.g.alchemy.com/v2/${ALCHEMY_KEY}`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ "id": 1, "jsonrpc": "2.0", "method": "alchemy_getAssetTransfers", "params": [params] }) });
                    const d = await res.json();
                    if(!d.result) break;
                    list = list.concat(d.result.transfers || []);
                    pageKey = d.result.pageKey;
                    loops++;
                    statusElement.innerText = `Fetching ${isIncoming?'IN':'OUT'}... (${list.length})`;
                    await new Promise(r => setTimeout(r, 100));
                } while(pageKey);
                return list;
            };
            const [inTxs, outTxs] = await Promise.all([fetchDir(true), fetchDir(false)]);
            accumulated = [...inTxs, ...outTxs];
            accumulated.sort((a, b) => parseInt(b.blockNum, 16) - parseInt(a.blockNum, 16));
            return accumulated.slice(0, limit);
        }
    </script>
</body>
</html>