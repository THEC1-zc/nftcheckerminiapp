<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAST Analyzer 7.3 (Full PnL)</title>
    
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        const run = async () => { await sdk.actions.ready(); };
        run();
    </script>

    <style>
        :root { --primary: #0052FF; --bg: #f5f5f7; --card-bg: #ffffff; --text: #1a1a1a; --green: #2ecc71; --red: #ff4757; --orange: #ff9f43; --purple: #9c27b0; --dark: #34495e; --pink: #d63384; --cyan: #00bcd4; --indigo: #3f51b5; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg);
            background-image: url('back.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--text); 
            padding: 15px; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-x: hidden; 
        }
        
        .nav-header { width: 100%; max-width: 600px; display: flex; margin-bottom: 20px; justify-content: space-between; align-items: center;}
        .back-btn { text-decoration: none; color: #666; font-weight: 600; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; }
        .wast-mini { font-weight: 900; font-size: 1rem; letter-spacing: 2px; color: var(--primary); margin-left: 10px; }
        
        .container { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.06); width: 100%; max-width: 600px; box-sizing: border-box; position: relative; }
        
        .input-group { margin-bottom: 15px; }
        label { display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.75rem; margin-bottom: 6px; color: #666; text-transform: uppercase; }
        
        .clear-link { 
            color: white; background-color: var(--primary); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; text-decoration: none; font-weight: 700; box-shadow: 0 2px 5px rgba(0,82,255,0.2); transition: opacity 0.2s;
        }
        .clear-link:hover { opacity: 0.8; }

        input, select { width: 100%; padding: 12px; border: 2px solid #e1e4e8; border-radius: 12px; font-size: 14px; outline: none; background: #fafafa; box-sizing: border-box; font-family: inherit; }
        
        .loading-text { font-size: 0.8rem; color: #999; font-style: italic; margin-top: 5px; display: none; text-align: center; }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; border: none; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: opacity 0.2s; color: white; }
        .btn-fast { background-color: var(--primary); color: white; }
        .btn-full { background-color: var(--dark); color: white; }
        .btn-hist { background-color: var(--purple); color: white; margin-top: 15px; display: none; } 

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 20px; margin-bottom: 10px; display: none; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #eee; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        
        /* NEW SIMPLE TEXT STATS */
        .stat-title { font-size: 0.7rem; text-transform: uppercase; font-weight: 800; color: var(--green); margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .stat-line { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; font-family: monospace; color: #333; }
        .stat-line strong { font-weight: 700; }
        .val-hist { color: var(--purple); }
        .val-curr { color: var(--primary); }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 10px; table-layout: fixed; }
        th { text-align: left; color: #999; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        td { padding: 10px 0; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .col-type { width: 40%; } .col-amount { width: 60%; text-align: right; }
        .tag { font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; font-weight: 700; text-transform: uppercase; margin-right: 4px; display: inline-block; }
        .bg-buy { background: #e6fffa; color: var(--green); border: 1px solid #b2f5ea; }
        
        .tx-sub { font-size: 0.7rem; color: #bbb; display: block; margin-top: 2px; }
        .tx-usd { font-size: 0.75rem; color: #666; font-weight: 500; }
        
        #status { text-align: center; margin: 15px 0; font-weight: 600; font-size: 0.85rem; min-height: 20px; padding: 0 10px; }

        .wip-tag { text-align: center; font-size: 0.9rem; color: #ff4757; margin-top: 10px; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; border: 2px dashed #ff4757; padding: 5px; border-radius: 8px; background: #fff5f5; }
        .version-tag { text-align: center; font-size: 0.7rem; color: #0052FF; margin-top: 25px; font-weight: 800; font-family: monospace; opacity: 0.8; }
    </style>
</head>
<body>

    <div class="nav-header">
        <a href="index.html" class="back-btn">‚¨Ö Home <span class="wast-mini">WAST</span></a>
    </div>

    <div class="container">
        <h2 style="text-align:center; margin-top:0;">Master Analyzer</h2>
        <p style="text-align:center; color:#666; font-size:0.8rem; margin-bottom:20px;">Logic: Buy Analysis & Time Machine</p>
        
        <div class="input-group">
            <label>Target Wallet <span id="btnChangeTarget" class="clear-link">Change üîÑ</span></label>
            <input type="text" id="walletInput" placeholder="0x..." />
        </div>

        <div class="input-group">
            <label>Token to Analyze <span id="toggleTokenMode" class="clear-link" style="background:#34495e;">Custom CA ‚úçÔ∏è</span></label>
            <div id="selectContainer"><select id="tokenSelect"><option value="" disabled selected>Waiting for wallet...</option></select><div id="loadingTokens" class="loading-text">Scanning...</div></div>
            <div id="inputContainer" style="display:none;"><input type="text" id="tokenInput" placeholder="Paste Token CA (0x...)" /></div>
        </div>

        <div class="btn-group">
            <button class="btn-fast" id="btnFast">‚ö° Last 500</button>
            <button class="btn-full" id="btnFull">üê¢ Deep (5k)</button>
        </div>
        
        <button id="btnHistory" class="btn-hist">üîÆ Fetch Historic Prices (Time Machine)</button>
        
        <div id="status"></div>

        <div id="dashboard" class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-title">BUY SUMMARY</div>
                <div class="stat-line"><span>Tokens:</span> <strong id="sumTokens">0</strong></div>
                <div class="stat-line"><span>Cost (Hist):</span> <strong id="sumHist" class="val-hist">---</strong></div>
                <div class="stat-line"><span>Value (Now):</span> <strong id="sumCurr" class="val-curr">$0.00</strong></div>
            </div>
        </div>

        <table id="txTable" style="display:none;">
            <thead><tr><th class="col-type">Type / Date</th><th class="col-amount">Amount / Value</th></tr></thead>
            <tbody id="txList"></tbody>
        </table>

        <div class="wip-tag">üöß WORK IN PROGRESS: BUY + TIME MACHINE üöß</div>
        <div class="version-tag">v7.3</div>
    </div>

    <script>
        const ALCHEMY_KEY = '46kIRKE_HvuVkuRbPNRbh'; 
        const MORALIS_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjliMTZhMzZkLWY0Y2MtNGRhNS1hY2EyLThjOWNhYzcyNzc1MiIsIm9yZ0lkIjoiNDkwMzU1IiwidXNlcklkIjoiNTA0NTEzIiwidHlwZUlkIjoiODUwM2NmZjEtMGRiZS00N2Q4LTkxMzQtNzM5NjQ2ZDMwZWI2IiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjgzODQ0NTcsImV4cCI6NDkyNDE0NDQ1N30.CHgE9uV5k_uW-44iveLhvre5kPPfuZ8Gnh4ifGOz2Uw'; 
        
        let globalBuys = []; 
        let currentTokenCA = "";
        let currentPricePerToken = 0; // Current Market Price
        let isCustomTokenMode = false;

        // INIT
        window.addEventListener('DOMContentLoaded', () => {
            const myIdentity = localStorage.getItem('tysm_wallet');
            if(myIdentity) document.getElementById('walletInput').value = myIdentity;
            const wInput = document.getElementById('walletInput');
            if(wInput.value) loadUserTokens(wInput.value);
        });

        // EVENTS
        document.getElementById('walletInput').addEventListener('change', (e) => {
            if(e.target.value.trim().startsWith('0x')) loadUserTokens(e.target.value.trim());
        });
        document.getElementById('btnChangeTarget').addEventListener('click', () => {
            document.getElementById('walletInput').value = "";
            document.getElementById('tokenSelect').innerHTML = '<option disabled selected>Waiting...</option>';
        });
        document.getElementById('toggleTokenMode').addEventListener('click', () => {
            const s = document.getElementById('selectContainer'), i = document.getElementById('inputContainer');
            if(s.style.display==='none'){s.style.display='block';i.style.display='none';isCustomTokenMode=false;}
            else{s.style.display='none';i.style.display='block';isCustomTokenMode=true;}
        });
        document.getElementById('tokenSelect').addEventListener('change', (e) => {
            document.getElementById('tokenInput').value = e.target.value;
        });

        // MORALIS PORTFOLIO LOAD
        async function loadUserTokens(walletAddr) {
            const select = document.getElementById('tokenSelect');
            const loading = document.getElementById('loadingTokens');
            select.style.display = 'none'; loading.style.display = 'block'; select.innerHTML = '';

            try {
                const url = `https://deep-index.moralis.io/api/v2.2/wallets/${walletAddr}/tokens?chain=base&exclude_spam=true&exclude_unpriced=false`;
                const response = await fetch(url, { method: 'GET', headers: { 'accept': 'application/json', 'X-API-Key': MORALIS_API_KEY }});
                const data = await response.json();
                
                if (!data.result || data.result.length === 0) { select.innerHTML = '<option disabled>No tokens found</option>'; return; }

                const valued = [], others = [];
                data.result.forEach(token => {
                    token.usd = token.usd_value ? parseFloat(token.usd_value) : 0;
                    token.bal = parseFloat(token.balance_formatted).toLocaleString(undefined, {maximumFractionDigits:4});
                    if(token.usd > 0.01) valued.push(token); else others.push(token);
                });
                valued.sort((a,b)=>b.usd-a.usd);
                others.sort((a,b)=>parseFloat(b.balance)-parseFloat(a.balance));

                select.innerHTML = '<option value="" disabled selected>Select a token...</option>';
                if(valued.length>0) {
                    const grp = document.createElement('optgroup'); grp.label="üí≤ VALUED";
                    valued.forEach(t => { 
                        const o = document.createElement('option'); o.value = t.token_address; 
                        o.innerText = `${t.symbol} - $${t.usd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
                        grp.appendChild(o);
                    });
                    select.appendChild(grp);
                }
                if(others.length>0) {
                    const grp = document.createElement('optgroup'); grp.label="‚ùì OTHERS";
                    others.forEach(t => { 
                        const o = document.createElement('option'); o.value = t.token_address; 
                        o.innerText = `${t.symbol} (${t.bal})`;
                        grp.appendChild(o);
                    });
                    select.appendChild(grp);
                }
            } catch(e) { console.error(e); select.innerHTML='<option disabled>Error</option>'; } 
            finally { loading.style.display='none'; select.style.display='block'; }
        }

        // BUTTONS
        document.getElementById('btnFast').addEventListener('click', () => runAnalysis(500)); 
        document.getElementById('btnFull').addEventListener('click', () => runAnalysis(5000)); 
        document.getElementById('btnHistory').addEventListener('click', fetchHistoricalPrices);

        // MAIN ANALYSIS
        async function runAnalysis(limit) {
            const wallet = document.getElementById('walletInput').value.trim().toLowerCase();
            currentTokenCA = isCustomTokenMode ? document.getElementById('tokenInput').value.trim().toLowerCase() : document.getElementById('tokenSelect').value.trim().toLowerCase();
            
            document.getElementById('dashboard').style.display='none';
            document.getElementById('txTable').style.display='none';
            document.getElementById('btnHistory').style.display='none';
            document.getElementById('txList').innerHTML = "";
            const status = document.getElementById('status');
            globalBuys = []; 

            if(!wallet.startsWith('0x') || !currentTokenCA.startsWith('0x')) return;

            status.innerText = "Initializing...";
            
            // 1. Get Current Price (for "Value (Now)")
            try {
                const dexRes = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${currentTokenCA}`);
                const dexData = await dexRes.json();
                if(dexData.pairs && dexData.pairs.length > 0) {
                    currentPricePerToken = parseFloat(dexData.pairs.find(p=>p.chainId==='base').priceUsd);
                }
            } catch(e){ currentPricePerToken = 0; }

            // 2. Fetch Deep History
            const rawTxs = await fetchUnifiedTransfers(wallet, currentTokenCA, limit, status);
            status.innerText = `Analyzing ${rawTxs.length} transactions...`;

            let totalTokens = 0;
            const tbody = document.getElementById('txList');

            // 3. Identify BUYs
            for(const tx of rawTxs) {
                const category = await analyzeBuy(tx, wallet, currentTokenCA);
                const val = parseFloat(tx.value);

                if(category === 'BUY') {
                    totalTokens += val;
                    const date = new Date(tx.metadata.blockTimestamp).toLocaleDateString();
                    
                    // Store for history fetch
                    globalBuys.push({
                        hash: tx.hash,
                        block: tx.blockNum, 
                        amount: val,
                        date: date,
                        rowId: `tx-${tx.hash}`
                    });

                    // Initial Row (Current Value displayed as placeholder)
                    const currVal = val * currentPricePerToken;
                    const row = `<tr id="tx-${tx.hash}">
                        <td class="col-type">
                            <span class="tag bg-buy">BUY</span> <span style="color:#999;font-size:0.7em">${date}</span>
                        </td>
                        <td class="col-amount">
                            <strong>${val.toLocaleString(undefined, {maximumFractionDigits:0})}</strong>
                            <span class="tx-usd" id="usd-${tx.hash}">Curr: $${currVal.toLocaleString(undefined, {maximumFractionDigits:2})}</span>
                        </td>
                    </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                }
            }

            // Update Summary Box (Initial State)
            document.getElementById('sumTokens').innerText = totalTokens.toLocaleString(undefined, {maximumFractionDigits:2});
            document.getElementById('sumCurr').innerText = `$${(totalTokens * currentPricePerToken).toLocaleString(undefined, {maximumFractionDigits:2})}`;
            document.getElementById('sumHist').innerText = "Click Time Machine"; // Placeholder

            document.getElementById('dashboard').style.display='grid';
            document.getElementById('txTable').style.display='table';
            
            if(globalBuys.length > 0) document.getElementById('btnHistory').style.display='block';
            
            status.innerText = "Analysis Complete ‚úÖ";
        }

        // --- TIME MACHINE (FETCH HISTORICAL PRICES) ---
        async function fetchHistoricalPrices() {
            const btn = document.getElementById('btnHistory');
            const status = document.getElementById('status');
            btn.disabled = true;
            btn.innerText = "‚è≥ Travelling in Time...";
            
            let totalHistoricalCost = 0;
            let processed = 0;
            
            for(const buy of globalBuys) {
                try {
                    status.innerText = `Fetching Price ${processed+1}/${globalBuys.length}...`;
                    
                    const blockInt = parseInt(buy.block, 16);
                    const url = `https://deep-index.moralis.io/api/v2.2/erc20/${currentTokenCA}/price?chain=base&to_block=${blockInt}`;
                    
                    const res = await fetch(url, { headers: { 'accept': 'application/json', 'X-API-Key': MORALIS_API_KEY }});
                    const data = await responseOk(res) ? await res.json() : {};
                    
                    if(data.usdPrice) {
                        const histPrice = parseFloat(data.usdPrice);
                        const txCost = buy.amount * histPrice;
                        totalHistoricalCost += txCost;
                        
                        // Update Row to show Historical Cost
                        const el = document.getElementById(`usd-${buy.hash}`);
                        if(el) {
                            el.innerText = `Hist: $${txCost.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
                            el.style.color = "#9c27b0"; // Purple for History
                            el.style.fontWeight = "700";
                        }
                    }
                    
                    processed++;
                    await new Promise(r => setTimeout(r, 220)); // Rate Limit Pacing

                } catch(e) { console.log("Skip", e); }
            }
            
            // Final Update of Summary Box
            document.getElementById('sumHist').innerText = `$${totalHistoricalCost.toLocaleString(undefined, {maximumFractionDigits:2})}`;
            
            status.innerText = "Historical Data Loaded üìú";
            btn.innerText = "‚úÖ Time Machine Complete";
        }

        async function responseOk(res) { return res.ok; }

        // --- CORE LOGIC: BUY ONLY ---
        async function analyzeBuy(tx, wallet, targetTokenCA) {
            const myWallet = wallet.toLowerCase();
            if (tx.to && tx.to.toLowerCase() !== myWallet) return 'IGNORE'; 

            try {
                const res = await fetch(`https://base-mainnet.g.alchemy.com/v2/${ALCHEMY_KEY}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ "id": 1, "jsonrpc": "2.0", "method": "eth_getTransactionReceipt", "params": [tx.hash] })
                });
                const d = await res.json();
                const logs = d.result?.logs || [];
                const TRANSFER = "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef";
                const walletTopic = "0x000000000000000000000000" + myWallet.replace("0x", "");

                let sentSomething = false;
                for(const log of logs) {
                    if(log.topics[0] !== TRANSFER) continue;
                    const contract = log.address.toLowerCase();
                    const fromMe = log.topics[1] && log.topics[1].toLowerCase() === walletTopic;
                    if (fromMe && contract !== targetTokenCA) {
                        sentSomething = true;
                        break; 
                    }
                }
                return sentSomething ? 'BUY' : 'IGNORE';
            } catch(e) { return 'IGNORE'; }
        }

        async function fetchUnifiedTransfers(wallet, token, limit, statusElement) {
            let accumulated = [];
            let pageKey = null;
            let count = 0;
            
            do {
                if(accumulated.length >= limit) break;
                statusElement.innerText = `Fetching page ${count+1}... (${accumulated.length} txs)`;
                
                const params = { 
                    "fromBlock": "0x0", "toBlock": "latest", 
                    "category": ["erc20"], "withMetadata": true, "excludeZeroValue": true, 
                    "contractAddresses": [token], "toAddress": wallet, "order": "desc", "maxCount": "0x3e8" 
                };
                if(pageKey) params.pageKey = pageKey;
                
                const res = await fetch(`https://base-mainnet.g.alchemy.com/v2/${ALCHEMY_KEY}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ "id": 1, "jsonrpc": "2.0", "method": "alchemy_getAssetTransfers", "params": [params] })
                });
                const d = await res.json();
                if(!d.result) break;
                
                accumulated = accumulated.concat(d.result.transfers || []);
                pageKey = d.result.pageKey;
                count++;
                await new Promise(r => setTimeout(r, 100));
            } while (pageKey);
            
            return accumulated;
        }
    </script>
</body>
</html>
